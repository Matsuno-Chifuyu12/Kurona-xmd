// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸ´ ğ›«ğ‘ˆğ‘…ğ›©ğ›®ğ›¥ â€” ğ‘¿ğ›­ğ‘« ğŸ´
//  The Ultimate WhatsApp Experience
// Handle "check join" button for Telegram users
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

import { isUserInChannel } from '../utils/checkmember.js';

export async function handleCheckJoin(bot, callbackQuery) {
  const chatId = callbackQuery.message.chat.id;
  const messageId = callbackQuery.message.message_id;
  const userId = callbackQuery.from.id;
  const userName = callbackQuery.from.first_name || "unknown";

  // Acknowledge the button press
  await bot.answerCallbackQuery(callbackQuery.id);

  try {
    await bot.deleteMessage(chatId, messageId);
    console.log("â•­â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•®\nâ”‚ ğŸ´ğ›«ğ‘ˆğ‘…ğ›©ğ›®ğ›¥ â€” ğ‘¿ğ›­ğ‘«ğŸ´ | Deleted check_join button message for user " + userId + "\nâ•°â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•¯");
  } catch (e) {
    console.warn("â•­â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•®\nâ”‚ ğŸ´ğ›«ğ‘ˆğ‘…ğ›©ğ›®ğ›¥ â€” ğ‘¿ğ›­ğ‘«ğŸ´ | Couldn't delete message for user " + userId + ":\nâ•°â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•¯", e.message);
  }

  try {
    const isMember = await isUserInChannel(bot, userId);
    console.log("â•­â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•®\nâ”‚ ğŸ´ğ›«ğ‘ˆğ‘…ğ›©ğ›®ğ›¥ â€” ğ‘¿ğ›­ğ‘«ğŸ´ | Membership check for user " + userId + ": " + isMember + "\nâ•°â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•¯");

    if (isMember) {
      await bot.sendPhoto(chatId, 'menu.jpg', {
        caption: "â•­â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•®\nâ”‚ ğŸ‘‹ğŸ¾ *Welcome back, " + userName + "!*\nâ”‚ \nâ”‚ You're all set. Use /menu to explore\nâ”‚ available options.\nâ•°â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•¯",
        parse_mode: 'Markdown'
      });
    } else {
      await bot.sendPhoto(chatId, 'menu.jpg', {
        caption: "â•­â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•®\nâ”‚ ğŸš« *You're not in the required groups yet!*\nâ”‚ \nâ”‚ Please make sure you've joined both\nâ”‚ the channel and group:\nâ”‚ \nâ”‚ âº [Join Channel](https://t.me/senku_tech_channel)\nâ”‚ âº [Join Group](https://t.me/senku_tech)\nâ”‚ \nâ”‚ Then press the button again.\nâ•°â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•¯",
        parse_mode: 'Markdown',
        reply_markup: {
          inline_keyboard: [
            [{ text: "âœ… I've Joined", callback_data: 'check_join' }]
          ]
        }
      });
    }

  } catch (err) {
    console.error("â•­â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•®\nâ”‚ ğŸ´ğ›«ğ‘ˆğ‘…ğ›©ğ›®ğ›¥ â€” ğ‘¿ğ›­ğ‘«ğŸ´ | Error handling check_join for user " + userId + ":\nâ•°â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•¯", err.message);
  }
}

export default handleCheckJoin;
