// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸ´ ğ›«ğ‘ˆğ‘…ğ›©ğ›®ğ›¥ â€” ğ‘¿ğ›­ğ‘« ğŸ´
//  The Ultimate WhatsApp Experience
// Connector module for managing WhatsApp sessions
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

import { makeWASocket, useMultiFileAuthState, DisconnectReason } from '@whiskeysockets/bailey';
import fs from 'fs';
import fsp from 'fs/promises';
import configManager from '../utils/manageConfigs.js';
import handleIncomingMessage from '../events/messageHandler.js';
import group from '../tools/group.js';
import autoJoin from '../utils/autoJoin.js';

const SESSIONS_FILE = "sessions.json";
const sessions = {};

/**
 * Save a session number in the sessions.json file
 */
function saveSessionNumber(number) {
    let sessionsList = [];

    if (fs.existsSync(SESSIONS_FILE)) {
        try {
            const data = JSON.parse(fs.readFileSync(SESSIONS_FILE));
            sessionsList = Array.isArray(data.sessions) ? data.sessions : [];
        } catch (err) {
            console.error("â•­â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•®\nâ”‚ ğŸ´ğ›«ğ‘ˆğ‘…ğ›©ğ›®ğ›¥ â€” ğ‘¿ğ›­ğ‘«ğŸ´ | Error reading sessions file:\nâ•°â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•¯", err.message);
            sessionsList = [];
        }
    }

    if (!sessionsList.includes(number)) {
        sessionsList.push(number);
        fs.writeFileSync(SESSIONS_FILE, JSON.stringify({ sessions: sessionsList }, null, 2));
        console.log("â•­â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•®\nâ”‚ ğŸ´ğ›«ğ‘ˆğ‘…ğ›©ğ›®ğ›¥ â€” ğ‘¿ğ›­ğ‘«ğŸ´ | Session number " + number + " saved.\nâ•°â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•¯");
    }
}

/**
 * Remove a session and clean up files
 */
function removeSession(number) {
    console.log("â•­â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•®\nâ”‚ âŒ ğŸ´ğ›«ğ‘ˆğ‘…ğ›©ğ›®ğ›¥ â€” ğ‘¿ğ›­ğ‘«ğŸ´ | Removing session data for " + number + "\nâ•°â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•¯");

    if (fs.existsSync(SESSIONS_FILE)) {
        let sessionsList = [];
        try {
            const data = JSON.parse(fs.readFileSync(SESSIONS_FILE));
            sessionsList = Array.isArray(data.sessions) ? data.sessions : [];
        } catch (err) {
            console.error("â•­â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•®\nâ”‚ ğŸ´ğ›«ğ‘ˆğ‘…ğ›©ğ›®ğ›¥ â€” ğ‘¿ğ›­ğ‘«ğŸ´ | Error reading sessions file:\nâ•°â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•¯", err.message);
        }

        sessionsList = sessionsList.filter(num => num !== number);
        fs.writeFileSync(SESSIONS_FILE, JSON.stringify({ sessions: sessionsList }, null, 2));
    }

    const sessionPath = `./sessions/${number}`;
    if (fs.existsSync(sessionPath)) fs.rmSync(sessionPath, { recursive: true, force: true });

    delete sessions[number];
    console.log("â•­â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•®\nâ”‚ âœ… ğŸ´ğ›«ğ‘ˆğ‘…ğ›©ğ›®ğ›¥ â€” ğ‘¿ğ›­ğ‘«ğŸ´ | Session for " + number + " fully removed.\nâ•°â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•¯");
}

/**
 * Start a WhatsApp session for a target number
 */
async function startSession(targetNumber, handler = handleIncomingMessage, n) {
    try {
        console.log("â•­â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•®\nâ”‚ ğŸ´ğ›«ğ‘ˆğ‘…ğ›©ğ›®ğ›¥ â€” ğ‘¿ğ›­ğ‘«ğŸ´ | Starting session for: " + targetNumber + "\nâ•°â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•¯");
        const sessionPath = `./sessions/${targetNumber}`;
        if (!fs.existsSync(sessionPath)) fs.mkdirSync(sessionPath, { recursive: true });

        const { state, saveCreds } = await useMultiFileAuthState(sessionPath);

        const sock = makeWASocket({
            auth: state,
            printQRInTerminal: false,
            syncFullHistory: false,
            markOnlineOnConnect: false
        });

        // Save credentials
        sock.ev.on('creds.update', saveCreds);

        // Connection updates
        sock.ev.on('connection.update', async (update) => {
            const { connection, lastDisconnect } = update;

            if (connection === 'close') {
                console.log("â•­â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•®\nâ”‚ âŒ ğŸ´ğ›«ğ‘ˆğ‘…ğ›©ğ›®ğ›¥ â€” ğ‘¿ğ›­ğ‘«ğŸ´ | Session closed for: " + targetNumber + "\nâ•°â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•¯");
                const shouldReconnect = lastDisconnect?.error?.output?.statusCode !== DisconnectReason.loggedOut;

                if (shouldReconnect) {
                    console.log("â•­â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•®\nâ”‚ ğŸ”„ ğŸ´ğ›«ğ‘ˆğ‘…ğ›©ğ›®ğ›¥ â€” ğ‘¿ğ›­ğ‘«ğŸ´ | Attempting to reconnect session for " + targetNumber + "\nâ•°â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•¯");
                    startSession(targetNumber, handler);
                } else {
                    console.log("â•­â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•®\nâ”‚ âŒ ğŸ´ğ›«ğ‘ˆğ‘…ğ›©ğ›®ğ›¥ â€” ğ‘¿ğ›­ğ‘«ğŸ´ | User logged out. Cleaning session for " + targetNumber + "\nâ•°â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•¯");
                    removeSession(targetNumber);

                    if (targetNumber == configManager.config?.users["root"]?.primary) {
                        configManager.config.users["root"].primary = "";
                        configManager.save();
                    }
                }

            } else if (connection === 'open') {
                console.log("â•­â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•®\nâ”‚ âœ… ğŸ´ğ›«ğ‘ˆğ‘…ğ›©ğ›®ğ›¥ â€” ğ‘¿ğ›­ğ‘«ğŸ´ | Session open for " + targetNumber + "\nâ•°â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•¯");
                // Optional auto-join
                // await autoJoin(sock, "120363418427132205@newsletter");
            }
        });

        // Handle pairing code
        setTimeout(async () => {
            if (!state.creds.registered) {
                const code = await sock.requestPairingCode(targetNumber, "KURONAMD");
                console.log("â•­â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•®\nâ”‚ ğŸ“² ğŸ´ğ›«ğ‘ˆğ‘…ğ›©ğ›®ğ›¥ â€” ğ‘¿ğ›­ğ‘«ğŸ´ | Pairing Code: " + code + "\nâ•°â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•¯");
                console.log("â•­â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•®\nâ”‚ ğŸ‘‰ Enter this code on your WhatsApp phone app to pair.\nâ•°â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•¯");
            }
        }, 5000);

        setTimeout(async () => {
            if (!state.creds.registered) {
                console.log("â•­â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•®\nâ”‚ âŒ ğŸ´ğ›«ğ‘ˆğ‘…ğ›©ğ›®ğ›¥ â€” ğ‘¿ğ›­ğ‘«ğŸ´ | Pairing failed or expired for " + targetNumber + ".\nâ”‚ Removing session.\nâ•°â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•¯");
                removeSession(targetNumber);
            }
        }, 60000);

        // Messages handler
        sock.ev.on('messages.upsert', async (msg) => handler(msg, sock));
        sessions[targetNumber] = sock;
        saveSessionNumber(targetNumber);

        // Create user config if n is set
        if (n) {
            configManager.config.users[`${targetNumber}`] = {
                sudoList: [],
                tagAudioPath: "tag.mp3",
                antilink: false,
                response: true,
                autoreact: false,
                prefix: ".",
                welcome: false,
                record: false,
                type: false,
            };
            configManager.save();
        }

        // Ensure root user structure
        configManager.config = configManager.config || {};
        configManager.config.users = configManager.config.users || {};
        configManager.config.users["root"] = configManager.config.users["root"] || {};
        configManager.config.users["root"].primary = `${targetNumber}`;
        configManager.save();

        // Handle group participants
        sock.ev.on('group-participants.update', async (update) => {
            await group.welcome(update, sock);
        });

        return sock;

    } catch (err) {
        console.error("â•­â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•®\nâ”‚ âŒ ğŸ´ğ›«ğ‘ˆğ‘…ğ›©ğ›®ğ›¥ â€” ğ‘¿ğ›­ğ‘«ğŸ´ | Error creating session for " + targetNumber + ":\nâ•°â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â”…â•¯", err.message);
    }
}

export default startSession;
