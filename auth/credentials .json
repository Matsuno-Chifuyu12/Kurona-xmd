// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// ğŸ´ ğ›«ğ‘ˆğ‘…ğ›©ğ›®ğ›¥ â€” ğ¶ğ‘…ğ¸ğ·ğ¸ğ‘ğ‘‡ğ¼ğ´ğ¿ ğŸ´
// Gestion centralisÃ©e des credentials et signedPreKey
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

import fs from "fs";
import path from "path";
import { generateSignedPreKey, useSingleFileAuthState } from '@whiskeysockets/baileys';

const SESSION_PATH = path.join(process.cwd(), "session", "auth_info_baileys.json");

// DurÃ©e maximale avant rÃ©gÃ©nÃ©ration d'une signedPreKey (30 jours)
const MAX_PREKEY_AGE = 30 * 24 * 60 * 60; // en secondes

// Charger la session existante
const { state, saveState } = useSingleFileAuthState(SESSION_PATH);

/**
 * VÃ©rifie si la signedPreKey est expirÃ©e
 */
function isPreKeyExpired() {
  const created = state.creds.signedPreKey?.created || 0;
  const now = Math.floor(Date.now() / 1000);
  return now - created >= MAX_PREKEY_AGE;
}

/**
 * RÃ©gÃ©nÃ¨re la signedPreKey et sauvegarde
 */
async function regenerateSignedPreKey() {
  const keyId = state.creds.signedPreKey?.keyId || 1;
  const newPreKey = generateSignedPreKey(state.creds.signedIdentityKey, keyId);

  state.creds.signedPreKey = {
    keyId: newPreKey.keyId,
    public: newPreKey.keyPair.public.toString("base64"),
    private: newPreKey.keyPair.private.toString("base64"),
    signature: newPreKey.signature.toString("base64"),
    created: Math.floor(Date.now() / 1000)
  };

  saveState();
  console.log(`âœ… Nouvelle signedPreKey gÃ©nÃ©rÃ©e (keyId=${keyId}, timestamp=${state.creds.signedPreKey.created})`);
}

/**
 * VÃ©rification automatique de la signedPreKey au dÃ©marrage et toutes les 24h
 */
export async function autoCheckAndRegen() {
  if (isPreKeyExpired()) {
    console.log("âš ï¸ signedPreKey expirÃ©e ou trop vieille. RÃ©gÃ©nÃ©ration...");
    await regenerateSignedPreKey();
  } else {
    const created = state.creds.signedPreKey.created;
    console.log(`âœ… signedPreKey encore valide (crÃ©Ã©e le ${new Date(created * 1000).toLocaleString()})`);
  }
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// FONCTIONS D'ACCÃˆS AUX CREDENTIALS
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

export function getCredentials() {
  return state.creds;
}

export function saveCredentials() {
  saveState();
  console.log("ğŸ’¾ Credentials sauvegardÃ©s avec succÃ¨s !");
}

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// EXÃ‰CUTION AUTOMATIQUE
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
autoCheckAndRegen().catch(console.error);
setInterval(autoCheckAndRegen, 24 * 60 * 60 * 1000); // toutes les 24h
